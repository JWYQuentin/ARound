---
title: "All_Genre_Pollstar"
author: "Alyssa"
date: "`r Sys.Date()`"
output:
  pdf_document: default
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Set up 

Note: 
- Market?
- why same country different currency

- Predict gross(revenue)
- non-sold related 

```{r, echo=FALSE, warning= FALSE, message = FALSE}
#read csv file
library(readr)
# %>%
library(dplyr)
#plotting
library(ggplot2)
#modeling
library(Stat2Data)
```

revised csv
  - removed na
  - renamed variables
```{r, eval = F}

df <- read_csv('Pollstar_all_genres.csv', show_col_types = FALSE)

# df1 <- df %>% na.omit(df) %>%
#  rename('date' = 'Event Date',
#         'number_of_shows' = 'Number of Shows',
         # 'artist' = 'Headliner',
         # 'sponsor' = 'Support',
         # 'country' = 'Country',
         # 'state' = 'State',
         # 'market' = 'Market',
         # 'company' = 'Company Type' ,
         # 'currency' = 'Currency',
         # 'promoter' = 'Promoter',
         # 'genre' = 'Genre',
         # 'ticket_sold' = 'Avg. Tickets Sold',
         # 'revenue' = 'Avg. Gross USD',
         # 'attendence' = 'Avg. Event Capacity',
         # 'percent_capacity' = 'Avg. Capacity Sold',
         # 'min_price' = 'Ticket Price Min USD',
         # 'max_price' = 'Ticket Price Max USD',
         # 'avg_price' = 'Ticket Price Avg. USD'
         # )

#write_csv(df1,'Pollstar_all_genres.csv')


# new df with necessary variables
df1 <- df %>% select(c(artist, date, number_of_shows, state,market, company, promoter, genre,attendence, min_price, max_price,  revenue))
colnames(df)
```

## check for data validity
```{r} 
#date distribution
ggplot(data = df1, aes(x = date)) + 
  geom_line(stat = "count", color = "black")+
  labs(title = "date distribution", x = "date", y = "number of available date on this date")

```

```{r}
#numerical distribution & outlier detection
price <- ggplot(data = df1, aes(x = min_price)) +
    geom_histogram(binwidth = 5, fill = "blue",color = "black")
price
# issue: min price > max price
invalid_min_max <- df1[df1$min_price > df1$max_price,]
invalid_min_max
# remove invalid rows
df2 <- anti_join(df1, invalid_min_max, by = names(invalid_min_max))
price_new <- ggplot(data = df2, aes(x = max_price)) +
    geom_histogram(binwidth = 5, fill = "blue",color = "black")
#summary for the cleaned dataset
summary(df2)
```
# Variable Modification:
  1. date to DOW 
  2. genre to fewer categories: (add multi-genre)
  3. sponsor to numeral: # of promoters
  4. state to regions (east, west etc)
  5. company to fewer categories: multi-companies
  6. promoter to fewer categories
  Note: 
   categories may still be too large after refine
   can't use: avg-price, ticket-sold, percent-capacity
   useless: currency, country, venue
   undecided: headliner(too large), city (too large)


```{r, eval=T}
# Convert DOW
df2$date <- as.Date(df2$date)
df2$date <- weekdays(df2$date)
#Combine Genre
df2genre <- ifelse(grepl(",", df1$genre), "Multi Genre", df1$genre )
df2
modified_genre = length(unique(df2$genre))
```


```{r, eval = T}
#convert to numerical 
number_convertion_by_comma <- function(str){
  if(grepl(",", str)){
    str = length((unlist(strsplit(str, ","))))
  }
  else{str = 1}
}
```

```{r, eval = T}
# df1$sponsor = df$sponsor
df2$promoter <- sapply(df2$promoter, number_convertion_by_comma)
df2$promoter <- as.integer(df2$promoter)
colnames(df2)
summary(df2)
```

## Divide to training-testing set (20% : 80%)

```{r}
set.seed(1)
rows <- sample(nrow(df2))
shuffled <- df2[rows,]
cut_off_index <- round(length(shuffled$date) * 0.8)
train_set <- shuffled[1:cut_off_index,]
test_set <- shuffled[(cut_off_index + 1): length(shuffled$date),]
```

```{r}
summary(train_set)
```

```{r}
summary(test_set)
```
```{r}
colnames(train_set)
```


## Model Selection, stepwise regression

```{r, eval = T}
df3 = select(train_set, c(2:12))
Full = lm(data = df3, revenue ~.)
MSE = (summary(Full)$sigma)^2
model = step(Full, scale=MSE)
RMSE = sqrt(summary(model)$sigma^2)
summary(model)
summary(model)$r.squared
RMSE
```

```{r, eval = T}
plot(model,c(1,2,5))
```

